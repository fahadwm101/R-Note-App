rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ---------------------------------------------------------
    // ğŸ› ï¸ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
    // ---------------------------------------------------------
    
    // 1. Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ØŸ
    function isSignedIn() {
      return request.auth != null;
    }

    // 2. Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠØŸ (Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø­Ø°Ù)
    function isOwner() {
      return isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // 3. Ù‡Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ­Ù…Ù„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµØ­ÙŠØ­ØŸ (Ù„Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‚Ø·)
    function isValidNewDoc() {
      return isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    // 4. Ù‡Ù„ Ø§Ù„Ù…Ù„Ù Ù…Ø³Ù…ÙˆØ­ Ø¨Ù†Ø´Ø±Ù‡ Ù„Ù„Ø¹Ø§Ù…Ø©ØŸ
    function isPublic() {
      return resource.data.isPublic == true;
    }

    // ---------------------------------------------------------
    // ğŸ”’ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ù…Ø§ÙŠØ© (Application Rules)
    // ---------------------------------------------------------

    // Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ø¹Ø§Ù…: Ù†Ù…Ù†Ø¹ Ø£ÙŠ ÙˆØµÙˆÙ„ ØºÙŠØ± Ù…Ø­Ø¯Ø¯
    match /{document=**} {
      allow read, write: if false;
    }

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }
    
    match /user_stats/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // ---------------------------------------------------------
    // ğŸ“ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ù…Ø©)
    // ---------------------------------------------------------

    // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ÙŠÙ‚Ø±Ø£Ù‡Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø£ÙŠ Ø´Ø®Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¹Ø§Ù…Ø©
    match /notes/{noteId} {
      allow read: if isOwner() || isPublic();
      allow create: if isValidNewDoc();  // âœ… ØªØ¶Ù…Ù† Ø£Ù†Ùƒ ØªÙ†Ø´Ø¦ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù†ÙØ³Ùƒ ÙÙ‚Ø·
      allow update, delete: if isOwner(); // âœ… Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø· ÙŠØ¹Ø¯Ù„ ÙˆÙŠØ­Ø°Ù
    }

    // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©: ÙŠÙ‚Ø±Ø£Ù‡Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£Ùˆ Ø£ÙŠ Ø´Ø®Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¹Ø§Ù…Ø©
    match /classes/{classId} {
      allow read: if isOwner() || isPublic();
      allow create: if isValidNewDoc();
      allow update, delete: if isOwner();
    }

    // ---------------------------------------------------------
    // ğŸ”’ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø®Ø§ØµØ© (Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø§Ù…Ø©)
    // ---------------------------------------------------------

    match /tasks/{taskId} {
      allow read, update, delete: if isOwner();
      allow create: if isValidNewDoc();
    }

    match /quizzes/{quizId} {
      allow read, update, delete: if isOwner();
      allow create: if isValidNewDoc();
    }

    match /assignments/{assignmentId} {
      allow read, update, delete: if isOwner();
      allow create: if isValidNewDoc();
    }

    // ---------------------------------------------------------
    // âš ï¸ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Legacy (Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ø¯ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ØŒ ÙŠÙØ¶Ù„ Ø­Ø°ÙÙ‡Ø§ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹)
    // ---------------------------------------------------------
    match /public/notes/{noteId} {
      allow read: if true;
      allow write: if isOwner(); 
    }
    match /public/schedules/{scheduleId} {
      allow read: if true;
      allow write: if isOwner();
    }
  }
}